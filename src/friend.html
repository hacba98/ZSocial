<html>
	<head>
		<title> Z-Social </title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
                <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="friend/friend.css">
		<script language="javascript">
                        var newfeed = 0;
                        
                        function removeFriend(id){
                            var url = "/friend/unfriend";
                            var params = "friendId=" + id;

                            var xmlHttp = new XMLHttpRequest();
                            xmlHttp.open('POST', url, true);
                            xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                            xmlHttp.onreadystatechange = function() {//Call a function when the state changes.
                                if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                    location.replace("/friend/");
                                } else if (xmlHttp.status == 404){
                                    alert("Error 500 not work");
                                }
                            }
                            xmlHttp.send(params);
                        }
                        
			function addFriend(){
				var flag = true;
				var friend_username = document.addfriendForm.friend_username.value;
				var message = document.addfriendForm.message.value;
				var url = "/friend/add";
				var params = "friend_username=" + friend_username + "&message=" + message;
				
				var http = new XMLHttpRequest();
				http.open('POST', url, true);
				http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
				http.onreadystatechange = function (){
					if(http.readyState == 4 && http.status == 200){
						alert("Your request had been sent.");
					} else if (http.status == 500 && flag){
						flag = false;
						alert("Username " + friend_username + " doesn't existed");
					} else if (http.status == 412 && flag){
						flag = false;
						alert("You have already sent this request. Please wait for your friend to accept it");
					}
				}
				http.send(params);
			}
                        
                        var socketURL = 'ws://10.40.30.214:8000/online';
                        var socket = new WebSocket(socketURL);

                        socket.addEventListener('open', function (event){
                            console.log('Open WS: ', socketURL);
                        });

                        socket.addEventListener('message', function (event){
                            console.log('Message receive', event.data);
                            if (event.data == "ping"){
                                    socket.send("pong");
                            } else {
                                    var data = event.data.split(":");

                                    if (data[0] == "online"){
                                            var id = "#friend_" + data[1];
                                            console.log(id);
                                            $(id).css("background-color", "yellowgreen");
                                    }

                                    if (data[0] == "offline"){
                                            var id = "#friend_" + data[1];
                                            console.log(id);
                                            $(id).css("background-color", "burlywood");
                                    }

                                    if (data[0] == "new_feed_come"){
                                        newfeed = newfeed + 1;
                                        console.log("U got new feed " + newfeed);
                                        $("#wall").css("background-color", "gold");
                                        $("#wall").text("Wall(" + newfeed + ")");
                                    }

                                    console.log(data);
                                    socket.send("ok");
                            }
                        });

                        window.onbeforeunload = function (){
                            socket.onclose = function (){
                                    console.log("web socket closing");
                            }
                            socket.close();
                        }
		</script>
	</head>
	<body>
		<div class="topnav">
                        <p> %s </p>
			<a href="/profile/logout">Logout</a>
			<a class="active" href="/friend">Friend</a>
			<a href="/message">Contact</a>
			<a href="/myprofile">Profile</a>
			<a href="/feed">My Feed</a>
			<a id ="wall" href="/dashboard">Wall</a>
		</div>

		<div class="split left">
			<form name="addfriendForm" onsubmit="addFriend()">
				<h2>Add Friend</h2>
				<label>Your Friend's Username </label><br>
				<input type="text" name="friend_username" required>
				<br><br>
				<label>Say something to your friend</label><br>
				<textarea name="message" rows="3" cols="25">Hi! Let's make friend!</textarea><br>
				<input type="button" value="Add Friend" onclick="addFriend()">
				<br><br>
			</form>
		</div>

		<div class="split right">
			<h2>View Friend Request</h2>
			<!--This will be load as list of pending requests-->
			%s
			<hr>
			<h2>View Friend List</h2>
			<!--This will be load as friends list-->
			%s
		</div>
	</body>
</html>
