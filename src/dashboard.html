<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
	<head>
                <meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
                <script>
                    var nextId = %d;
                    var nextPost = %d;
		    var newfeed = 0;
                    var newfriend = %d;
                    function loadmore(){
                        var params = "next.id=" + nextId + "&next.post=" + nextPost;
                        var url = "/newsFeed/loadmore-mywall";
                        //console.log(params);

                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.open('POST', url, false);
                        xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                        xmlHttp.onreadystatechange = function() {//Call a function when the state changes.
                            if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                nextId = xmlHttp.getResponseHeader("next.id");
                                nextPost = xmlHttp.getResponseHeader("next.post");
                                let div = document.createElement('div');
                                div.innerHTML = xmlHttp.getResponseHeader("data");

                                document.getElementById("feeds").appendChild(div);
                            } else if (xmlHttp.status == 404){
                                alert("NO MORE FEED!");
                            }
                        }
                        xmlHttp.send(params);
                    }    
                    
                    function postfeed(){
                        var content = document.getElementsByName("content")[0].value;
			
                        var params = "content=" + content;
                        var url = "/newsFeed/create";
                        //console.log(params);

                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.open('POST', url, false);
                        xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                        xmlHttp.onreadystatechange = function() {//Call a function when the state changes.
                            if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                let the_id = xmlHttp.getResponseHeader("new_feed_id");
                                let now = new Date();
                                let append_content = "<form class='card' name='feed_no_" + the_id + "' onsubmit='updateFeed('" + the_id + "')'>" +
                                    "<h1>" + document.getElementById("user_name").textContent + "</h1>" +
                                    "<p class='price'> Date:" + now.toLocaleString() + "</p>" +
                                    "<textarea class='status_post' rows='4' name='content'>" + content + "</textarea><br>" +
                                    "<input type ='button' class='updateBTN' onClick='updateFeed(" +'"' + the_id +'"' +  ")' value='UPDATE'>" +
                                    "<input type ='button' class='deleteBTN' onClick='removeFeed(" +'"' + the_id +'"' + ")' value='REMOVE'>" +
                                    "</form> <hr><br><br>";
                                //console.log(append_content);
                                let div = document.createElement('div');
                                
                                div.innerHTML = append_content;
                                document.getElementById("feeds").prepend(div);
                                
                            } else if (xmlHttp.status == 404){
                                alert("post feed not susscess!!");
                            }
                        }
                        xmlHttp.send(params);
                    }
                    
                    function updateFeed(name){
                
                        var x = document.getElementsByName('feed_no_'+ name)[0];
                        var content = x.content.value;
                        var url = "/newsFeed/update";
                        var params = "id=" + name + "&content=" + content;

                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.open('POST', url, true);
                        xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                        xmlHttp.onreadystatechange = function() {//Call a function when the state changes.
                            if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                            
                            } else if (xmlHttp.status == 404){
                            alert("Error 500 not work");
                            }
                        }
                        xmlHttp.send(params);
                    }

                    function removeFeed(name){
                        console.log(name);

                        var url = "/newsFeed/delete";
                        var params = "id=" + name;
                        console.log(params);

                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.open('POST', url, true);
                        xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                        xmlHttp.onreadystatechange = function() {//Call a function when the state changes.
                            if(xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                            
                            } else if (xmlHttp.status == 404){
                                alert("Error 500 not work");
                            }
                        }
                        xmlHttp.send(params);
                    }
		    
    		    var nextFriendPos = 10;

		    // function to load more friends data in the list
		    function loadmore_friends(){
			var params = "next=" + nextFriendPos;
			var url = "/friend/loadmore";
			
			var http = new XMLHttpRequest();
			http.open('POST', url, false);
			http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			http.onreadystatechange = function() {//Call a function when the state changes.
                            if(http.readyState == 4 && http.status == 200) {
                                // nextId = http.getResponseHeader("next");
                                nextFriendPos = http.getResponseHeader("next");
                                let div = document.createElement('div');
                                div.innerHTML = http.getResponseHeader("data");

                                document.getElementById("friends").appendChild(div);
				
                            } else if (http.status == 404){
                                alert("NO MORE FRIEND!");
                            }
                        }
                        http.send(params);
		    }
		    
		    var socketURL = 'ws://10.40.30.214:8000/online';
		    var socket = new WebSocket(socketURL);
		    
		    socket.addEventListener('open', function (event){
			console.log('Open WS: ', socketURL);
		    });
		    
		    socket.addEventListener('message', function (event){
			console.log('Message receive', event.data);
			if (event.data == "ping"){
				socket.send("pong");
			} else {
				var data = event.data.split(":");
				
				if (data[0] == "online"){
					var id = "#friend_" + data[1];
					console.log(id);
					$(id).css("background-color", "yellowgreen");
				}
				
				if (data[0] == "offline"){
					var id = "#friend_" + data[1];
					console.log(id);
					$(id).css("background-color", "burlywood");
				}
				
                                if (data[0] == "new_feed_come"){
                                    newfeed = newfeed + 1;
                                    //console.log("U got new feed " + newfeed);
                                    $("#wall").css("background-color", "gold");
                                    $("#wall").text("Wall(" + newfeed + ")");
                                }
                                
                                if (data[0] == "new_friend_come"){
                                    newfriend = newfriend + 1;
                                    //console.log("U got new friend " + newfriend);
                                    
                                    $("#friend_link").text("Friend(" + newfriend + ")");
                                }
                                
				console.log(data);
				socket.send("ok");
			}
		    });
		    
		    window.onbeforeunload = function (){
			socket.onclose = function (){
				console.log("web socket closing");
			}
			socket.close();
		    }
		    
                </script>
		<style>
			body {
				margin: 0;
				font-family: Arial, Helvetica, sans-serif;
			}

			.topnav {
				overflow: hidden;
				background-color: #007acc;
			}
                        
                        .topnav p {
				float: left;
				color: #f2f2f2;
				text-align: center;
				
				text-decoration: none;
				font-size: 17px;
			}

			.topnav a {
				float: right;
				color: #f2f2f2;
				text-align: center;
				padding: 14px 32px;
				text-decoration: none;
				font-size: 17px;
			}

			.topnav a:hover {
				background-color: #ddd;
				color: black;
			}

			.topnav a.active {
				background-color: #4CAF50;
				color: white;
			}
			
			.split {
				height: 95%%;
				width: 20%%;
				position: fixed;
				z-index: 1;
				top: 4.5%%;
				overflow-x: hidden;
				padding-top: 20px;
			}

			.right {
				right: 0;
				background-color: aqua;
			}

			.left {
				left: 0;
				background-color: seashell;
			}
			
			.center {
                                right: 0;
				width: 80%%;
				background-color: cornsilk;
			}
			
			.centered {
				position: absolute;
				top: 10%%;
				left: 50%%;
				transform: translate(-50%%, 0%%);
				text-align: center;
			}
			
			.status_post {
				min-height: 100px;
				width: 350px;
				border: solid 1px silver;
				background: #fff;
			}
			
			.post_button{
				
			}
                        .card {
                            box-shadow: 0 8px 12px 0 rgba(0, 0, 0, 0.2);
                            max-width: 500px;
                            margin: auto;
                            text-align: center;
                            font-family: countryside;
                            background-color: white;
                        }

                        .price {
                            color: grey;
                            font-size: 12px;
                        }

                        .card button {
                            border: none;
                            outline: 0;
                            padding: 12px;
                            color: white;
                            background-color: #2479ff;
                            text-align: center;
                            cursor: pointer;
                            width: 100%%;
                            font-size: 18px;
                        }

                        .card button:hover {
                            background-color: #1a64d9;
                        }
                        
                        .friend {
                            border: none;
                            outline: 0;
			    padding: 5px;
                            color: white;
                            
                            text-align: center;
                            cursor: pointer;
                            width: 100%%;
                            font-size: 20px;
			    margin: 15px;
			    border-radius: 20px;
                        }
                        .friend_offline {
                            background-color: burlywood;
                        }
                        .friend_online {
                            background-color: yellowgreen;
                        }
                        .friend:hover {
                            background-color: steelblue;
                        }
                        .loadmoreBTN {
                            border: white;
                            padding: 12px;
                            color: white;
                            background-color: blue;
                            text-align: center;
                            width: 100%%;
                            font-size: 18px;
                        }
                        .loadmoreBTN:hover {
                            background-color: #1a64d9;
                        }
                        
                        .updateBTN {
                            border: white;
                            outline: 0;
                            padding: 12px;
                            color: white;
                            background-color: #2479ff;
                            text-align: center;
                            cursor: pointer;
                            width: 50%%;
                            font-size: 18px;
                            left : 0;
                            position: fixed;
                        }
                        .deleteBTN {
                            border: white;
                            outline: 0;
                            padding: 12px;
                            color: white;
                            background-color: blue;
                            text-align: center;
                            cursor: pointer;
                            width: 50%%;
                            font-size: 18px;
                            right: 0;
                            position: fixed;
                        }
                        .updateBTN:hover {
                            background-color: #1a64d9;
                        }
                        .deleteBTN:hover {
                            background-color: #1a64d9;
                        }
		</style>
	</head>
	<body>
		<div class="topnav">
                        <p id="user_name"> %s </p>
			<a href="/profile/logout">Logout</a>
			<a id ="friend_link" href="/friend">%s</a>
			<a href="/message">Contact</a>
			<a href="/myprofile">Profile</a>
			<a href="/feed">My Feed</a>
			<a id ="wall" class="active" href="/dashboard">Wall</a>
		</div>
		
		<div class="split center" onscroll="scrolled_feeds(this)">
			<div class="centered" id = "listfeed">
                            <div id="registerForm">
                                <p>What is in your mind?</p>
                                <textarea class="status_post" rows="4" name="content"></textarea><br>
                                <button class="post_button" onclick="postfeed()">Post</button>
                            </div>
                            <hr>
                            <div id="feeds">
					
					%s

                    </div>

                    <div>
					<br><br>
                        <button class="loadmoreBTN" onclick="loadmore()"> load more...</button>
                    </div>
                </div>
            </div>
	    <div class="split left" onscroll="scrolled_friends(this)" id="friends">
                %s
            </div>
		
		<script>
			function scrolled_feeds(o){
				// check if reach end of page
				if (o.offsetHeight + o.scrollTop == o.scrollHeight && nextId != -1){
					loadmore();
				}
			}
			
			function scrolled_friends(o){
				// check if reach end of page
				if (o.offsetHeight + o.scrollTop <= o.scrollHeight && nextFriendPos != -1){
					loadmore_friends();
				}
			}
		</script>
	</body>
	
</html>
